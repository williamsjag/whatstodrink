{% extends "layout.html" %}

{% block title %}
    Add Cocktail
{% endblock %}

{% block main %}
    <h1 class="text-center mb-5">Add Cocktail</h1>
    <div class="center-wide text-center explainer p-3 mb-5">
        <p>Add a new recipe to your database.</p>
    </div>
    <div class="container">
        <!-- Add cocktail form -->
        <form action="/addcocktail" id="amountsForm" class="item-center center-form" method="post" novalidate>
            {{ form.csrf_token }}
            <!-- name field -->
            <div class="form-group mb-3">
                {{ form.name.label(class="form-control-label") }}
                {% if form.name.errors %}
                        {{ form.name(class="form-control is-invalid") }}
                        <div class="invalid-feedback">
                            {% for error in form.name.errors %}
                                <span>{{ error }}</span>
                            {% endfor %}
                        </div>
                {% else %}
                    {{ form.name(class="form-control") }}
                {% endif %} 
            </div>
                <!--ingredients list -->
            <div class="mb-3 form-group">
                <!-- <label for="q0" class="form-label">Ingredients</label> -->
                {{ form.ingredient.label(class="form-control-label mb-3") }}
                <ol id="dynamicSelects">
                    <!-- first ingredient -->
                    <li id="q0" class="row">
                        <div class="col-md-4">
                            <label>Amount (with units)</label>
                            <input type="text" class="form-control amountlist" name="amount" placeholder="e.g. 1 1/2 ounces">

                        </div>
                        <div class="col">
                            <label>Ingredient</label>
                            <input type="text" class="form-control ingredientlist mb-3" placeholder="Type to search" name="q" hx-get="/ingredientsearch" hx-trigger="keyup changed delay:300ms" hx-target="#results">
                            <!-- ingredient search table -->
                            <table id ="searchtable" class="table table-sm table-borderless table-hover">
                                <tbody id="results">
                            </table>
                        </div>
                    </li>
                </ol>
                
            </div>
            <!-- Create new ingredient button -->
            <div class="mb-3 text-center">
                <button class="btn btn-primary btn-sm" id="new_ingredient" hx-get="/addingredientmodal" hx-target="#ingredientModal" hx-trigger="click" type="button" data-bs-toggle="modal" data-bs-target="#ingredientModal">Create New Ingredient</button>
            </div>
            <!-- Build instructions field -->
            <div class="form-group mb-3">
                {{ form.build.label(class="form-control-label") }}
                {{ form.build(class="form-control", placeholder="Build instructions, garnish, glass, etc...", rows="3") }}
            </div>
            <!-- Source field -->
            <div class="form-group mb-3">
                {{ form.source.label(class="form-control-label") }}
                {{ form.source(class="form-control") }}
            </div>
            <!-- Family field -->
            <div class="mb-3 form-group">
                {{ form.family.label(class="form-control-label") }}  <i class="fa-solid fa-circle-info" data-bs-toggle="modal" data-bs-target="#familyModal"></i>
                <select name="family" class="form-select" id="family">
                    <option value="" disabled selected>--Family--</option>
                    <option value="Old Fashioneds">Old Fashioneds</option>
                    <option value="Sours">Sours</option>
                    <option value="Vermouth Cocktails">Vermouth Cocktails</option>
                    <option value="Amaro Cocktails">Amaro Cocktails</option>
                    <option value="Duos and Trios">Duos and Trios</option>
                    <option value="Champagne Cocktails">Champagne Cocktails</option>
                    <option value="Highballs">Highballs</option>
                    <option value="Juleps and Smashes">Juleps and Smashes</option>
                    <option value="Hot Drinks">Hot Drinks</option>
                    <option value="Flips and Nogs">Flips and Nogs</option>
                    <option value="Tiki Cocktails">Tiki Cocktails</option>
                    <option value="Punches">Punches</option>
                    <option value="Orphans">Orphans</option>
                </select>
            </div>
            <!-- Notes field -->
            <div class="form-group mb-3">
                {{ form.notes.label(class="form-control-label") }}
                {{ form.notes(class="form-control", placeholder="Any additional information", rows="3") }}
            </div>
            <!-- Submit button / open amounts modal -->
            <div class="form-group mb-3 text-center">
                {{ form.submit(class="btn btn-primary mt-3") }}
            </div>
        </form>
    </div>


    <!-- Modal for adding ingredient -->
    <div class="modal fade" id="ingredientModal" tabindex="-1" aria-labelledby="ingredientModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content" id="modal-form"></div>
        </div>
    </div>

    <!-- Family Helper modal -->
    <div class="modal fade" id="familyModal" tabindex="-1" aria-labelledby="familyModalLabel" aria-hidden="true">
        <div class="modal-dialog">
          <div class="modal-content">
            <div class="modal-header">
              <h1 class="modal-title fs-5" id="exampleModalLabel">Cocktail Family</h1>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>The type of cocktail.</p>
                <p><span class="blue">Old Fashioneds: </span>The original cocktail. Spirit, sugar, and water.</p>
                <p><span class="blue">Sours: </span>e.g. Gimlet, Margarita. They usually contain a sour element like lemon juice balanced by sugar.</p>
                <p><span class="blue">Vermouth Cocktails: </span>Cocktails like Americanos that use vermouth prominently.</p>
                <p><span class="blue">Amaro Cocktails: </span>Drinks like Negronis that feature Amari.</p>
                <p><span class="blue">Duos and Trios: </span>Spirit and Mixer combos (think Rusty Nail). Add cream to make it a trio (White Russian).</p>
                <p><span class="blue">Champagne Cocktails: </span>For something fizzy and festive, throw in some Champagne!</p>
                <p><span class="blue">Highballs: </span>Longer drinks with a higher percentage of non-alcoholic mixers.</p>
                <p><span class="blue">Juleps and Smashes: </span>Spirit forward and served over crushed ice, often with mint and/or extra fruit.</p>
                <p><span class="blue">Hot Drinks: </span>Your Irish Coffees and Hot Toddies.</p>
                <p><span class="blue">Flips and Nogs: </span>If it has a whole egg in it, it probably belongs here.</p>
                <p><span class="blue">Tiki Cocktails: </span>You know it when you see it. It probably comes in a fun mug. </p>
                <p><span class="blue">Punches: </span>Spirit, juice, sugar, spice water. Great for a party!</p>
                <p><span class="blue">Orphans: </span>Creations that don't fit into a mold.</p>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
          </div>
        </div>
      </div>
    
{% endblock %}
{% block javascript %}
<script>
    document.addEventListener('DOMContentLoaded', function () {
        document.querySelector('form[id="amountsForm"] input[name="name"]').focus();
    })
    // counter variable for ids
    var counter = 1;
    
    document.addEventListener('DOMContentLoaded', function() {
        attachEventListeners();
    });

    function attachEventListeners() {

        var searchTable = document.getElementById('results');

        if (searchTable) {

            searchTable.addEventListener('click', function(event) {

                // check if click is a cell
                if (event.target.tagName === "TD") {
                    // copy original empty field
                    var originalElement = document.querySelector("#dynamicSelects li:last-child");

                    // create a new one
                    var newDiv = originalElement.cloneNode(true);

                    // set new id
                    newDiv.id = 'q' + counter;

                    // clear new inputs and table
                    var resultsTable = newDiv.querySelector("#results");
                    resultsTable.innerHTML = '';
                    inputs = newDiv.querySelectorAll('input');
                    inputs.forEach(function(input) {
                        input.value = '';
                    });

                    // remove labels from new inputs
                    newDiv.querySelectorAll('label').forEach(function(label) {
                        label.remove();
                    })
                    // remove old searchtable
                    originalElement.querySelector("#searchtable").remove();

                    //increment counter
                    counter++;

                    // add new div to dynamicSelects
                    var hostdiv = document.getElementById('dynamicSelects');
                    hostdiv.appendChild(newDiv);

                    // get content of clicked cell
                    var ingredientval = event.target.textContent;

                    // set old field to cellval
                    var newInput = document.querySelector("#dynamicSelects li:last-child .amountlist")
                    var newIngredient = document.querySelector("#dynamicSelects li:last-child .ingredientlist")
                    document.querySelector("#dynamicSelects li:nth-last-child(2) .ingredientlist").value = ingredientval;
                    // make readonly
                    var oldInput = document.querySelector("#dynamicSelects li:nth-last-child(2) .ingredientlist")
                    oldInput.setAttribute('readonly', 'true');
                    oldInput.removeAttribute('hx-trigger');
                    oldInput.removeAttribute('hx-get');
                    oldInput.removeAttribute('hx-target');

                    // focus new field
                    newInput.focus();

                    htmx.process(newIngredient);
                    attachEventListeners();
                }
            })
        }
    }

        
</script>
{% endblock %}
